{% extends "base.html" %}
{% block TITLE %}Shopping Cart{% endblock %}
{% block CONTENT %}
<div class="container mt-5">
    <h2>Shopping Cart</h2>
    {% if parts %}
        <form method="POST" action="{{ url_for('purchase_cart') }}">
            {{ form.hidden_tag() }}
            <table class="table">
                <thead>
                    <tr>
                        <th>Part Name</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in parts %}
                    <tr>
                        <td>{{ item.part.name }}</td>
                        <td>${{ "%.2f"|format(item.part.price) }}</td>
                        <td>
                            <!-- Quantity input field with dynamic attributes -->
                            <input type="number" 
                                   name="quantities[{{ item.part.id }}]" 
                                   value="{{ item.quantity }}" 
                                   min="1" 
                                   class="form-control quantity-input" 
                                   data-part-id="{{ item.part.id }}" 
                                   data-price="{{ item.part.price }}" 
                                   style="width: 80px;">
                        </td>
                        <td class="item-subtotal" id="subtotal-{{ item.part.id }}">
                            ${{ "%.2f"|format(item.part.price * item.quantity) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <h4>Total Price: $<span id="total-price">{{ "%.2f"|format(total_price) }}</span></h4>

            <!-- Add margin for spacing -->
            <div class="mt-5"></div>

            <!-- Payment Information -->
            <h3>Payment Information</h3>
            <p>We only accept payment in advance and your order will be saved for now. If we receive the money from your order, we will process your order. Here are our bank details:</p>
            <p><strong>PartWatch GmbH</strong></p>
            <p><strong>IBAN:</strong> DE89 3704 0044 0532 0130 00</p>
            <p><strong>BIC:</strong> COBADEFFXXX</p>
            <p><strong>Reference: </strong> Order-ID {{ next_order_id }}</p>

            <button type="submit" class="btn btn-primary">Purchase</button>
        </form>

        <!-- Display form errors if any -->
        {% if form.errors %}
        <div class="alert alert-danger">
            <ul>
            {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                    <li>{{ getattr(form, field).label.text }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    {% else %}
        <p>Your cart is empty.</p>
    {% endif %}
</div>

<!-- JavaScript for dynamic price updates -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const quantityInputs = document.querySelectorAll('.quantity-input');
        const totalPriceElement = document.getElementById('total-price');

        function formatCurrency(value) {
            return parseFloat(value).toFixed(2);
        }

        function updateTotal() {
            let totalPrice = 0;

            quantityInputs.forEach(function(input) {
                const quantity = parseInt(input.value) || 1;
                const price = parseFloat(input.getAttribute('data-price'));
                const partId = input.getAttribute('data-part-id');
                const subtotalElement = document.getElementById('subtotal-' + partId);
                const subtotal = price * quantity;
                subtotalElement.textContent = '$' + formatCurrency(subtotal);
                totalPrice += subtotal;
            });

            totalPriceElement.textContent = formatCurrency(totalPrice);
        }

        quantityInputs.forEach(function(input) {
            input.addEventListener('input', updateTotal);
        });

        updateTotal();
    });
</script>
{% endblock %}
